{% extends "template.html" %}
{% block title %}Parties - WTM Harvard{% endblock %}
{% block content %}
<div class="container">
    <h1>Upcoming Parties</h1>
    <p>Discover the best parties happening at Harvard this week.</p>
    
    <div class="list-actions">
        <button class="btn ghost" id="toggle-map-btn" type="button">Show party map</button>
        {% if session.get('user') %}
        <a class="btn primary" href="/add">Add a party</a>
        {% endif %}
    </div>
    
    <!-- Interactive Map -->
    <div class="map-panel" id="map-panel" style="display: none;">
        <div class="card-header" style="margin-bottom: 8px;">
            <h5>Party Map - Harvard Square</h5>
        </div>
        <div class="card-body">
            <div id="map" style="height: 400px; width: 100%; border-radius: 8px;"></div>
        </div>
    </div>
    
    <!-- List of Parties -->
    <div class="party-list">
        {% if parties and parties|length > 0 %}
            {% for party in parties %}
            <div class="party-card">
                <!-- Heart button for wishlist -->
                {% if session.get('user') %}
                <button 
                    class="wishlist-btn" 
                    data-party-id="{{ party.id }}"
                    data-in-wishlist="{{ 'true' if party.id in user_wishlist else 'false' }}"
                >
                    {% if user_wishlist and party.id in user_wishlist %}
                        ‚ù§Ô∏è
                    {% else %}
                        ü§ç
                    {% endif %}
                </button>
                {% endif %}
                
                <!-- Image card -->
                <a class="party-card-link" href="/party/{{ party['id'] }}">
                    <!-- Flyer/image for party -->
                    {% if party.flyer_path %}
                    <div style="margin-bottom: 12px;">
                        <img src="{{ url_for('static', filename=party.flyer_path) }}" 
                             alt="{{ party.party_name }} flyer"
                             style="max-width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px;">
                    </div>
                    {% endif %}
                    
                    <div class="party-card-header">
                        <h3>{{ party['party_name'] }}</h3>
                        <div class="party-date">{{ party['date'] }} @ {{ party['time'] }}</div>
                    </div>
                    
                    <p class="party-meta">
                        Hosted by {{ party['verified_host'] }} 
                        <span class="badge bg-success" style="font-size: 0.75rem;">‚úì Verified</span>
                        ‚Ä¢ {{ party['location'] }}
                    </p>
                    
                    {% if party['description'] %}
                    <p>{{ party['description'][:150] }}{% if party['description']|length > 150 %}...{% endif %}</p>
                    {% endif %}
                </a>
            </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-secondary">
                No parties have been added yet. Be the first to add one!
            </div>
        {% endif %}
    </div>
</div>

<!-- CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    let map;
    let mapInitialized = false;

    function initMap() {
        if (mapInitialized) {
            map.invalidateSize();
            return;
        }
        map = L.map('map').setView([42.3736, -71.1190], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        fetch('/api/parties/map')
            .then(response => response.json())
            .then(parties => {
                parties.forEach(party => {
                    if (party.latitude && party.longitude) {
                        const marker = L.marker([party.latitude, party.longitude]).addTo(map);
                        marker.bindPopup(`
                            <strong>${party.name}</strong><br>
                            Hosted by: ${party.host}<br>
                            Location: ${party.location}<br>
                            Date: ${party.date} at ${party.time}<br>
                            <a href="/party/${party.id}">View Details</a>
                        `);
                    }
                });
            })
            .catch(error => console.error('Error loading party locations:', error));

        mapInitialized = true;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const toggleBtn = document.getElementById('toggle-map-btn');
        const mapPanel = document.getElementById('map-panel');

        toggleBtn.addEventListener('click', function() {
            const isHidden = mapPanel.style.display === 'none' || mapPanel.style.display === '';
            if (isHidden) {
                mapPanel.style.display = 'block';
                toggleBtn.textContent = 'Hide party map';
                initMap();
            } else {
                mapPanel.style.display = 'none';
                toggleBtn.textContent = 'Show party map';
            }
        });

        document.querySelectorAll('.wishlist-btn').forEach(button => {
            button.addEventListener('click', function(event) {
                event.stopPropagation();
                event.preventDefault();
                
                const partyId = this.getAttribute('data-party-id');
                const btn = this;
                
                fetch(`/party/${partyId}/wishlist`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.action === 'added') {
                        btn.textContent = '‚ù§Ô∏è';
                        btn.dataset.inWishlist = 'true';
                    } else {
                        btn.textContent = 'ü§ç';
                        btn.dataset.inWishlist = 'false';
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
    });
</script>
{% endblock %}
